                        "ISTEC 1008 INTERN"  **********************************************************************  *                       Schnittstellenprotokoll                      *  **********************************************************************  Schnittstellenparameter:  9600 Baud, 8N1, Handshake: None  Die Uebertragung geschieht grundsaetzlich in Segmenten zu je 4Byte:  +-----------+-----------+-----------+-----------+  | x000 00xx | xxxx xxxx | xxxx xxxx | xxxx xxxx |  +-----------+-----------+-----------+-----------+    |        |      \-------------------------/  Endemarke  |       Datenbytes, ungenutzte Bytes         Anzahl der  sind 00 oder FF         Datenbytes  Jeweils eine Anzahl Segmente mit dem Startbyte 0x03 und drei Daten-  bytes sowie ein abschliessendes Segment mit dem Startbyte 0x81-0x83  und entsprechend ein bis drei weiteren Datenbytes bilden zusammen  eine Nachricht. Das erste Byte einer solchen Nachricht bestimmt  ihre Funktion, der Rest sind Parameter.  Pruefsummen oder aehnliches gibt es nicht.  Beispiele:    03 DD 07 01 83 00 01 00          == Opcode 0xDD, Parameter "07 01 00 01 00"    82 18 01 00          == Opcode 0x18, Parameter "01"  **********************************************************************  *                   Nachrichten vom PC an die ISTEC                   *  **********************************************************************  Opcode  Parameter           Funktion  ~~~~~~  ~~~~~~~~~~~~~~~~    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   0x01    --                 Abschluss Gebuehrenzaehler nach                              Schreiben.   0x0b    --                 Ruecksetzen der Anlage auf                              Werkseinstellungen.   0x02    --                 Bereitschaft pruefen   0x05    128Byte Gebueh-    Schreiben Gebuehrenzaehler           rendaten           Fuer jedes der 64 moeglichen Endgeraete sind                              zwei Bytes reserviert.   0x06    --                 Abfrage Gebuehrenzaehler   0x07    1Byte Endgeraete-  Schreiben Endgeraetekonfiguration           nummer, gefolgt    Endgeraetenummer: 0x00=Nebenstelle 21,           von 16Byte Kon-    0x01=Nebenstelle 22, usw. bis 0x3F           figurationsdaten   0x08    --                 Abfrage Endgeraetekonfiguration                              Nach dem Empfangen dieser Anweisung sendet                              die ISTEC hintereinanderweg 64 Antwortnach-                              richten des Typs 0x16 (siehe unten), ent-                              sprechend den 64 moeglichen Endgeraeten.   0x09    93Byte Konfi-      Schreiben Grundkonfiguration           gurationsdaten     (wird nicht quittiert!)   0x0a    --                 Abfrage Grundkonfiguration   0x0c    --                 Abschluss Konfiguration (Daten in Permanent-                              speicher uebernehmen!?)   0xdd    5Byte Parameter,   Diagnoseanweisung           siehe unten  **********************************************************************  *                Nachrichten von der ISTEC an den PC                  *  **********************************************************************  Opcode  Parameter           Funktion  ~~~~~~  ~~~~~~~~~~~~~~~     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   0x11    --                 Positive Quittung fuer das Kommando 0x0c   0x12    --                 Antwort auf 0x02, Bereitschaft pruefen   0x15    128Byte Gebueh-    Antwort auf 0x06, Abfrage Gebuehren           rendaten           Fuer jedes der 64 moeglichen Endgeraete sind                              zwei Bytes reserviert.   0x16    1Byte Endgeraete-  Antwort auf 0x08, Konfiguration abfragen           nummer, gefolgt    Endgeraetenummer: 0x00=Nebenstelle 21,           von 16Byte Kon-    0x01=Nebenstelle 22, usw. bis 0x3F           figurationsdaten   0x17    93Byte Konfi-      Antwort auf 0x0a, Konfiguration abfragen           gurationsdaten   0x18    Endgeraetenummer   Quittung fuer 0x07, Schreiben Endgeraetekonfig   0xdd    5Byte Parameter,   Diagnosestatus           siehe unten  **********************************************************************  *                         Diagnosenachrichten                         *  **********************************************************************  Richtung  Parameterbytes   Funktion  ~~~~~~~~  ~~~~~~~~~~~~~~   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    -->      00 69 5A 96 A5  Diagnosemodus einschalten    -->      01 00 00 00 00  Diagnosemodus beenden   <-->      02 ss gg zz 00  Verbindungsmatrix                             ss=Spalte, gg=Endgeraet, zz=0:aus,=1:ein   <-->      03 gg 00 zz 00  Ruf (gg=Endgeraet, zz=0:aus,=1:ein)    <--      04 gg 00 zz 00  Schleifenzustand                             gg=Endgeraet, zz=0:inaktiv ,=1:aktiv    <--      05 gg 00 zz 00  Impulswahl erkannt                             gg=Endgeraet, zz=gewaehle Ziffer                             (0x10=R-Taste)    <--      06 kk 00 zz 00  Tonwahl erkannt                             kk=Kanal (0:IVb1,1:IVb2),                             zz=gewaehlte Ziffer   <-->      07 01 00 zz 00  LED Zustand (zz=0:aus, =1:ein)    -->      08 ll 00 zz 00  Gebuehren (ll=Leitung, zz=0:aus,=1:ein)    -->      09 00 00 zz 00  TFE-Verstaerker (zz=0:aus, 1:ein)    <--      09 FF FF zz 00    -->      0A 00 00 zz 00  Tueroeffner (zz=0:aus, =1:ein)    <--      0A FF FF zz 00    -->      0D 00 00 00 00  Schalter abfragen (zz=0:aus, =1:ein)    <--      0D 00 00 zz 00  **********************************************************************  *                   Datenstruktur Grundkonfiguration                  *  **********************************************************************  Offset  Bytes   Typ      Funktion  ~~~~~~  ~~~~~   ~~~~~    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     0       1    Flag     Anschlussart: 0=Mehrgeraete-,1=Anlagenanschluss     1       1    Binaer   Anzahl der a/b-Schnittstellen     2       1    Flag     Protokoll: 0=1TR6, 1=E-DSS1     3       2    Binaer   Software Versionsnummer     5       1    Binaer   TFE-Zuordnung (0x15=21,0x16=22,...)     6       5    BCD      MSN 0    11       5    BCD      MSN 1    16       5    BCD      MSN 2    21       5    BCD      MSN 3    26       5    BCD      MSN 4    31       5    BCD      MSN 5    36       5    BCD      MSN 6    41       5    BCD      MSN 7    46       5    BCD      MSN 8    51       5    BCD      MSN 9    56       1    Flag     Music on Hold (00=aus,01=ein)    57       1    Binaer   Anzahl der internen S0-Busse    58       1    Binaer   Anzahl der externen S0-Busse    59       1    Binaer   Abfragestelle1 (0x15=21,0x16=22,...)    60       1    Binaer   Abfragestelle2 (0x15=21,0x16=22,...)    61       1    Binaer   Anzahl der Ziffern in der 1.Rufnummer    62      10    ASCII    1.Rufnummer, mit 0x00 aufgefuellt    72       1    Binaer   Anzahl der Ziffern in der 2.Rufnummer    73      10    ASCII    2.Rufnummer, mit 0x00 aufgefuellt    83      10   Bitmaske  MSN Gruppenbildung: Fuer jede der 10 MSN's                           ein Byte, in dem die einzelnen Bits angeben,                           welche der 8 Nebenstellen klingeln sollen.                           Auch bei den groesseren Anlagen bleibt es bei                           8Bit pro MSN; keine Ahnung, wie die weiteren                           Nebenstellen adressiert werden...    93      --ENDE--  BCD-Werte sind mit "F" aufgefuellt, wenn nicht die volle Stellenzahl  benoetigt wird. Die erste Ziffer steht jeweils im LSB.  **********************************************************************  *               Datenstruktur Endgeraetekonfiguration                 *  **********************************************************************  Offset  Bytes   Typ      Funktion  ~~~~~~  ~~~~~   ~~~~~    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     0       1    Flag     Wahlbewertung: 00=keine,01=Inland,...     1       1    Flag     Dienst: 00=Telefonie,01=G3-FAX,...     2       1    Binaer   Rufumleitung: 00=keine,01=extern,                           0x15=Nebenstelle 21,0x16=Nebenstelle 22,usw.     3       1    Flag     Gebuehrenimpuls: 00=nein,01=ja     4       2    BCD      PIN     6      10    BCD      Rufnummer fuer externe Rufumleitung    16      --ENDE--  BCD-Werte sind mit "F" aufgefuellt, wenn nicht die volle Stellenzahl  benoetigt wird. Die erste Ziffer steht jeweils im LSB.  **********************************************************************  *            Aufbau der Konfigurationsdateien (*.IC)                  *  **********************************************************************  Offset  Bytes   Funktion  ~~~~~~  ~~~~~   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     0       93   Daten der Grundkonfiguration    93        1   0x00    94       16   Konfiguration Endgeraet 21   110        1   0x00   111       16   Konfiguration Endgeraet 22    :         :    :         :   usw., insgesamt 64 Endgeraetedatensaetze    :         :  1181        3   0x00  1184     --ENDE--  ErgŠnzend sollte man fuer die Programmierung auch sagen, da§ es sein kann,  da§ zwischen dem Senden der einzelnen Nachrichtenpakete bzw. nach dem  Senden der Konfigurationsdaten eine kurze Pause notwendig ist, bevor  weitergesendet wird. Ansonsten ist es mšglich, da§ die Istec nicht mehr  "mitkommt" und einfach aussteigt. Sie schickt dann manchmal als Antwort  0x1302, manchmal aber auch gar nichts mehr. Bei mir (Metin) hat eine Pause  von 1/50 Sekunde zwischen den Paketen und eine weitere von 1/25 Sekunde  nach Senden jeweils der Grund- und EngerŠtekonfigurationen, sowie der  GebŸhrendaten geholfen.  **********************************************************************  *                            THE END ....                            *  **********************************************************************